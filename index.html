<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <title></title>

	<!-- grab d3 via cdn -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	
	<!-- custom css for project -->
	<link href="project.css" rel="stylesheet">
	
    <!-- Bootstrap core CSS -->
    <link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy this line! -->
    <!--[if lt IE 9]><script src="../../assets/js/ie8-responsive-file-warning.js"></script><![endif]-->

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <!-- Static navbar -->
    <div class="navbar navbar-default navbar-static-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">CO2 World Emissions Data Visualization</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Visualization</a></li>
            <li><a href="#about">About</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

	<!-- Bootstrap content container -->
    <div class="container-fluid">
    	<div class="row">
			<div class="col-md-10">
				<div class="row">
				<div id="mapContainer"></div>
				</div>
			</div>
			<div class="col-md-2">
				<div class="well">
					<h4>Map Key & Control</h4>
					<hr>
					<div class="btn-group">
					  <button id="curYear" type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
						Select Year <span class="caret"></span>
					  </button>
					  <ul id="YearDropDown" class="dropdown-menu scrollable-menu" role="menu">
					  </ul>
					</div>
					<br /><br />
					<button type="button" class="btn btn-default">Animate (1960-2012)</button>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="col-md-1"></div>
			<div class="col-md-10">
				<div class="well">
					<h3>CO2 World Emissions Data Visualization: Project Description</h3>
					<hr>
					<h4>Data</h4>
					<hr>
					Our dataset comes from the World Bank. 
					<br />URL: <a href="http://data.worldbank.org/indicator/EN.ATM.CO2E.PC">http://data.worldbank.org/indicator/EN.ATM.CO2E.PCmetric</a> 
					<br />Units: METRIC TONS PER CAPITA 
				</div>
			</div>
			<div class="col-md-1"></div>
		</div>
    </div> <!-- /container -->


    <!-- Core javascript libraries (delivered via CDN)
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="datamaps.world.min.js"></script>
	
	<script type="text/javascript">
	
	// Load data from CSV and convert to JSON
	var dataset = new Object(); //Array of Country codes, each code is array of (fillKey -> key)
	var colorset = new Object(); //Array of years, each year is array of (country codes -> #color code)
	var colors = d3.scale.linear()
	 	.domain([0, 20, 41])
	 	.range(["green", "yellow", "grey"]);
	var map;
	var yr = 1960;
	var count = 0;
	d3.csv("data.csv", function(data) {
	//console.log(data);
		
		data.forEach(function(row) {
		  if(row["Country;Code"].length == 3 && row["Country;Code"]!= " RB"){ //The country Venezuela, RB is messing up results
			dataset[row["Country;Code"]] = new Object();
			
			
			for(var prop in row) {
				if(count == 0 && parseInt(prop) > 1959 && parseInt(prop) < 2013 && prop.length == 4){
					colorset[prop] = new Object();
				}
				if (parseInt(prop) > 1959 && parseInt(prop) < 2013 && prop.length == 4){
					if(parseFloat(row[prop]) > 0){
						//dataset[row["Country;Code"]][prop] = row[prop];
						colorset[prop][row["Country;Code"]] = colors(parseFloat(row[prop]));
					}else{
						//dataset[row["Country;Code"]][prop] = -1;
						colorset[prop][row["Country;Code"]] = "#DDDDDD";
					}
				}
			}
			dataset[row["Country;Code"]]["fillKey"] = row["Country;Code"];
			if(d3.select("#YearDropDown")[0][0].childElementCount==0){
				// Set the year dropdown list
				Object.keys(row).forEach(function(propertyName){
					// Only add years to the list (use regex to detect alpha chars)
					if(!propertyName.substring(0,1).match(/^[A-z]+$/) && propertyName.length == 4)
						// Add the year to the dropdown list
						d3.select("#YearDropDown").append("li").html("<a class='year' href='#"+propertyName+"'>" + propertyName + "</a>");
				});
			}
			count++;
		  }
		});
		
		yr = parseInt(window.location.hash.substring(1));
		if (yr > 1959 && yr < 2013)
			map_year(yr);
		else{
			yr = 1960;
			map_year(yr);
		}
		
		
		map = new Datamap({
	    	element: document.getElementById('mapContainer'), 
	    	data: dataset,
	    	fills: colorset[yr],
			//colorset[yr],
			
			geographyConfig: {
		    	popupTemplate : function (geo, data) {
		    		//console.log(data)
		    		if(data != null)
		    	 		return  ['<div class="hoverinfo">' +  data["Country Name"], '</div>'].join('');
		    	 }
		    },
			
	    	setProjection: function (element) {
	    		var projection = d3.geo.cylindricalStereographic()
	    			.parallel(30)
	    			.scale($(element).width()/6)
	    			.translate([$(element).width()/2, $(element).height()/2]);

	    		var path = d3.geo.path()
	    			.projection(projection);
	    		return {path: path, projection: projection};
	    	}
    	});
		
		$("a.year").click(function(){
			yr = parseInt($(this).html());
			if(yr > 0) map_year(yr);
		});
		
		function map_year(year){
			$("#curYear").html(year + " <span class='caret'></span>");
			window.setTimeout(function() {
	 	
				map.updateChoropleth(colorset[year]);
				
			}, 500);

		}
		
	});

	 
    </script>
  </body>
</html>
